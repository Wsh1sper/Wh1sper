<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>舒尔特方格训练 & 特工选择</title>
  <style>
    body {
      margin: 0;
      font-family: 'Microsoft Yahei', sans-serif;
      background-color: #f2f2f2;
    }
    .container {
      max-width: 900px;
      margin: 30px auto;
      padding: 30px;
      background-color: #fff;
      text-align: center;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #222;
      font-size: 32px;
      margin-bottom: 20px;
    }
    #navBtns {
      margin-bottom: 30px;
    }
    #navBtns button {
      background-color: #2196f3;
      margin: 0 10px;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    #navBtns button:hover {
      background-color: #1e88e5;
    }

    #settings {
      margin-bottom: 10px;
    }
    #settings select {
      font-size: 18px;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      cursor: pointer;
      user-select: none;
    }

    #timer {
      display: none;
    }

    #grid {
      display: grid;
      gap: 8px;
      justify-content: center;
      margin: 0 auto 20px;
      position: relative;
      border-radius: 12px;
      background: #fafafa;
      box-shadow: inset 0 0 5px #ddd;
      user-select: none;
      min-height: 360px;
      width: fit-content;
    }

    .cell {
      width: 90px;
      height: 90px;
      line-height: 90px;
      font-size: 32px;
      background-color: #f8f8f8;
      border: none;
      cursor: pointer;
      border-radius: 6px;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    .cell.correct {
      background-color: #b2fab4;
      cursor: default;
    }
    .cell:active {
      background-color: #a0e59b;
    }

    #goLargeBtn {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 64px;
      font-weight: 700;
      background-color: transparent;
      color: #4caf50;
      border: none;
      padding: 0;
      cursor: pointer;
      user-select: none;
      transition: color 0.3s ease;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: none;
      width: auto;
      height: auto;
      min-width: 150px;
      min-height: 100px;
    }
    #goLargeBtn:hover {
      color: #388e3c;
      background-color: transparent;
      border: none;
      box-shadow: none;
    }

    #restartBtn {
      background-color: #f44336;
      color: white;
      border: none;
      padding: 10px 24px;
      font-size: 18px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
      display: none;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    #restartBtn:hover {
      background-color: #d32f2f;
    }

    #timeResult {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 56px;
      font-weight: 700;
      color: #4caf50;
      user-select: none;
      display: none;
      z-index: 20;
      background-color: rgba(255, 255, 255, 0.85);
      padding: 20px 40px;
      border-radius: 12px;
      box-shadow: 0 0 10px #4caf50aa;
      pointer-events: none;
      white-space: nowrap;
      text-align: center;
      width: fit-content;
      max-width: 100%;
    }

    #scoreBoard {
      margin-top: 15px;
      font-size: 18px;
      color: #333;
      min-height: 90px;
      border-top: 1px solid #ddd;
      padding-top: 10px;
      text-align: left;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      user-select: none;
    }

    /* 特工选择模块样式 */
    #heroPage {
      display: none;
      text-align: center;
    }
    #heroSettings {
      margin-bottom: 20px;
      user-select: none;
    }
    #heroSettings select,
    #heroSettings input,
    #heroSettings button {
      font-size: 18px;
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-left: 10px;
      cursor: pointer;
      user-select: none;
      transition: border-color 0.3s ease, background-color 0.3s ease;
    }
    #heroSettings select:focus,
    #heroSettings input:focus {
      border-color: #2196f3;
      outline: none;
    }
    #heroSettings button {
      background-color: #4caf50;
      color: white;
      border: none;
    }
    #heroSettings button:hover {
      background-color: #45a049;
    }
    #heroResult {
      font-size: 20px;
      color: #555;
      min-height: 28px;
      margin-top: 10px;
      user-select: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="pageTitle">舒尔特方格训练</h1>

    <div id="navBtns">
      <button onclick="showPage('schulte')">舒尔特方格</button>
      <button onclick="showPage('hero')">特工选择</button>
    </div>

    <!-- 舒尔特方格设置 -->
    <div id="settings">
      方格大小：
      <select id="gridSize">
        <option value="5">5x5</option>
        <option value="6">6x6</option>
        <option value="7">7x7</option>
      </select>
    </div>

    <div id="timer">用时：0.0 秒</div>

    <!-- 舒尔特方格网格 -->
    <div id="grid">
      <button id="goLargeBtn">Go</button>
      <div id="timeResult"></div>
    </div>

    <button id="restartBtn">重新开始</button>

    <!-- 成绩板 -->
    <div id="scoreBoard">
      <strong>最近5次成绩：</strong><br />
      <ul id="scoreList" style="padding-left: 20px; margin-top: 6px;"></ul>
      <div id="averageTime" style="margin-top: 8px; font-weight: bold;"></div>
    </div>

    <!-- 特工选择模块 -->
    <div id="heroPage">
      <div id="heroSettings">
        抽取分类：
        <select id="agentCategory">
          <option value="all">全部</option>
          <option value="duel">决斗</option>
          <option value="pioneer">先锋</option>
          <option value="sentinel">哨位</option>
          <option value="controller">控场</option>
        </select>
        抽取人数：
        <input id="heroCount" type="number" value="1" min="1" max="10" />
        <button id="randomAgentBtn">随机特工</button>
      </div>
      <div id="heroResult"></div>
    </div>
  </div>

  <script>
    // ==================== 舒尔特方格相关 ====================
    let current = 1;
    let timerInterval;
    let startTime;
    const maxScores = 5;

    // 独立保存不同尺寸成绩
    const scores = {
      5: [],
      6: [],
      7: []
    };

    const settingsDiv = document.getElementById('settings');
    const gridDiv = document.getElementById('grid');
    const timerDiv = document.getElementById('timer');
    const goLargeBtn = document.getElementById('goLargeBtn');
    const restartBtn = document.getElementById('restartBtn');
    const heroPage = document.getElementById('heroPage');
    const gridSizeSelect = document.getElementById('gridSize');
    const timeResultDiv = document.getElementById('timeResult');
    const scoreList = document.getElementById('scoreList');
    const averageTimeDiv = document.getElementById('averageTime');
    const scoreBoardDiv = document.getElementById('scoreBoard');

    const clickSound = new Audio(
      'https://actions.google.com/sounds/v1/buttons/button_press_short.ogg'
    );

    function updateGridSize() {
      const size = parseInt(gridSizeSelect.value);
      const cellSize = 90;
      const gap = 8;
      const totalSize = size * cellSize + (size - 1) * gap;
      gridDiv.style.width = totalSize + 'px';
      gridDiv.style.height = totalSize + 'px';
    }

    updateGridSize();
    gridSizeSelect.addEventListener('change', () => {
      updateGridSize();
      resetToInitial();
      updateScores();
    });

    function showPage(page) {
      if (timerInterval) clearInterval(timerInterval);

      if (page === 'schulte') {
        heroPage.style.display = 'none';
        settingsDiv.style.display = 'block';
        gridDiv.style.display = 'grid';
        timerDiv.style.display = 'none';
        restartBtn.style.display = 'none';
        timeResultDiv.style.display = 'none';

        resetToInitial();

        document.getElementById('pageTitle').textContent = '舒尔特方格训练';

        scoreBoardDiv.style.display = 'block';
      } else if (page === 'hero') {
        heroPage.style.display = 'block';
        settingsDiv.style.display = 'none';
        gridDiv.style.display = 'none';
        timerDiv.style.display = 'none';
        restartBtn.style.display = 'none';
        timeResultDiv.style.display = 'none';

        document.getElementById('pageTitle').textContent = '特工选择';

        scoreBoardDiv.style.display = 'none';
      }
    }

    function resetToInitial() {
      if (timerInterval) clearInterval(timerInterval);

      [...gridDiv.children].forEach((el) => {
        if (el !== goLargeBtn && el !== timeResultDiv) {
          gridDiv.removeChild(el);
        }
      });

      goLargeBtn.style.display = 'flex';
      timeResultDiv.style.display = 'none';
      timerDiv.style.display = 'none';
      timerDiv.textContent = '用时：0.0 秒';
      current = 1;

      restartBtn.style.display = 'none'; // 初始状态隐藏重新开始按钮
    }

    function updateScores() {
      const size = gridSizeSelect.value;
      const currentScores = scores[size] || [];

      scoreList.innerHTML = '';
      currentScores.forEach((t, i) => {
        const li = document.createElement('li');
        li.textContent = `第${i + 1}次：${t.toFixed(2)} 秒`;
        scoreList.appendChild(li);
      });

      if (currentScores.length > 0) {
        const avg =
          currentScores.reduce((a, b) => a + b, 0) / currentScores.length;
        averageTimeDiv.textContent = `平均用时：${avg.toFixed(2)} 秒`;
      } else {
        averageTimeDiv.textContent = '';
      }
    }

    goLargeBtn.onclick = () => {
      const size = parseInt(gridSizeSelect.value);
      const cellSize = 90;
      const gap = 8;

      goLargeBtn.style.display = 'none';
      timeResultDiv.style.display = 'none';

      [...gridDiv.children].forEach((el) => {
        if (el !== goLargeBtn && el !== timeResultDiv) {
          gridDiv.removeChild(el);
        }
      });

      gridDiv.style.gridTemplateColumns = `repeat(${size}, ${cellSize}px)`;
      gridDiv.style.gridTemplateRows = `repeat(${size}, ${cellSize}px)`;

      current = 1;
      startTime = Date.now();

      timerDiv.style.display = 'none';

      let numbers = Array.from({ length: size * size }, (_, i) => i + 1);
      numbers.sort(() => Math.random() - 0.5);

      numbers.forEach((num) => {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.textContent = num;
        cell.onclick = () => {
          if (parseInt(cell.textContent) === current) {
            cell.classList.add('correct');
            clickSound.currentTime = 0;
            clickSound.play().catch(() => {});

            current++;
            if (current > size * size) {
              clearInterval(timerInterval);
              const elapsed = (Date.now() - startTime) / 1000;

              if (!scores[size]) scores[size] = [];
              scores[size].push(elapsed);
              if (scores[size].length > maxScores) scores[size].shift();

              updateScores();

              timeResultDiv.textContent = `用时：${elapsed.toFixed(2)} 秒`;
              timeResultDiv.style.display = 'flex';

              [...gridDiv.children].forEach((el) => {
                if (el !== goLargeBtn && el !== timeResultDiv) {
                  el.style.display = 'none';
                }
              });

              restartBtn.style.display = 'inline-block'; // 完成后显示按钮
            }
          }
        };
        gridDiv.appendChild(cell);
      });

      restartBtn.style.display = 'inline-block'; // 训练开始后显示重新开始按钮
    };

    restartBtn.onclick = () => {
      resetToInitial();
    };

    // ==================== 特工选择模块 ====================
    const agents = [
      { name: '捷风', category: 'duel' },
      { name: '雷兹', category: 'duel' },
      { name: '不死鸟', category: 'duel' },
      { name: '芮娜', category: 'duel' },
      { name: '夜露', category: 'duel' },
      { name: '霓虹', category: 'duel' },
      { name: '壹决', category: 'duel' },
      { name: '幻棱', category: 'duel' },
      { name: '铁臂', category: 'pioneer' },
      { name: '猎枭', category: 'pioneer' },
      { name: 'K/O', category: 'pioneer' },
      { name: '黑梦', category: 'pioneer' },
      { name: '盖可', category: 'pioneer' },
      { name: '钛狐', category: 'pioneer' },
      { name: '斯凯', category: 'pioneer' },
      { name: '贤者', category: 'sentinel' },
      { name: '零', category: 'sentinel' },
      { name: '奇乐', category: 'sentinel' },
      { name: '尚博勒', category: 'sentinel' },
      { name: '钢索', category: 'sentinel' },
      { name: '维斯', category: 'sentinel' },
      { name: '幽影', category: 'controller' },
      { name: '炼狱', category: 'controller' },
      { name: '蝰蛇', category: 'controller' },
      { name: '星礈', category: 'controller' },
      { name: '海神', category: 'controller' },
      { name: '暮蝶', category: 'controller' }
    ];

    let lastDraw = [];

    function randomHero() {
      const category = document.getElementById('agentCategory').value;
      const count = Math.min(
        parseInt(document.getElementById('heroCount').value),
        10
      );

      let pool;
      if (category === 'all') {
        pool = agents.map((a) => a.name);
      } else {
        pool = agents.filter((a) => a.category === category).map((a) => a.name);
      }

      if (pool.length === 0) {
        document.getElementById('heroResult').textContent = '该分类无特工可抽取。';
        return;
      }

      // 最多尝试10次，保证抽取结果与上次无重复
      let result = [];
      let attempts = 0;
      let tempResult = [];
      while (attempts < 10) {
        const copy = [...pool];
        tempResult = [];
        for (let i = 0; i < count; i++) {
          if (copy.length === 0) break;
          const idx = Math.floor(Math.random() * copy.length);
          tempResult.push(copy.splice(idx, 1)[0]);
        }

        // 检查tempResult是否和lastDraw有重复
        const hasOverlap = tempResult.some(name => lastDraw.includes(name));
        if (!hasOverlap) {
          result = tempResult;
          break;
        }

        attempts++;
      }

      // 如果尝试多次后仍有重复，则直接用最后一次结果
      if (result.length === 0) {
        result = tempResult;
      }

      lastDraw = result;

      document.getElementById('heroResult').innerHTML =
        '抽取结果：' + result.map((h) => `<strong>${h}</strong>`).join('，');
    }

    document.getElementById('randomAgentBtn').addEventListener('click', randomHero);

    // 初始化显示舒尔特方格页面
    showPage('schulte');
  </script>
</body>
</html>

